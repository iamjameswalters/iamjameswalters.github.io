<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="generator" content="Pelican" />
  <title>james.walters.click - Insecurely Copying Text in Javascript</title>
  <meta name="description" content="Thoughts and lessons learned along the path of software development." />
  <link rel="stylesheet" type="text/css" href="https://james.walters.click/theme/css/pico.min.css" />
  <link rel="stylesheet" type="text/css" href="https://james.walters.click/theme/css/prism.css" />
  <link
    href="https://james.walters.click/feeds/all.atom.xml"
    type="application/atom+xml" rel="alternate" title="james.walters.click Full Atom Feed" />




    <meta name="tags" content="JavaScript" />

  <link href="https://james.walters.click/theme/css/fonts.css" rel="stylesheet" type="text/css" />
  <style>
    article img {
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    #hero {
      align-items: center; 
      margin-bottom: 0;
    }

    @media only screen and (min-width: 481px) { 

      article header {
        display: grid;
      }

      article aside {
        justify-content: end
      }
      
      #hero {
      display: flex; 
    }

    #hero div {
      display: flex;
    }

    #hero img {
      width: 200px;
    }
  }

  @media only screen and (max-width: 480px) { 
    #hero div {
      display: block;
      text-align: center;
    }

    #hero img {
      width: 150px;
      margin-top: 2em;
    }
  }
  </style>
  <script type="text/javascript" src="https://james.walters.click/theme/js/prism.js" defer></script>
</head>

<body>
  <header class="container">
  <nav>
    <ul>
      <li><a href="https://james.walters.click">All Posts</a></li>
    </ul>
    <ul>

        <li><a href="https://james.walters.click/category/linux.html">Linux</a></li>
        <li><a href="https://james.walters.click/category/meta.html">Meta</a></li>
        <li><a href="https://james.walters.click/category/python.html">Python</a></li>
        <li><strong><a href="https://james.walters.click/category/web.html">Web</a></strong></li>
        <li><a href="https://james.walters.click/category/weeknotes.html">Weeknotes</a></li>

    </ul>
  </nav>
  </header>
  <main style="padding-bottom: 0;padding-top: 0;" class="container">
<section id="hero">
  <hgroup style="grid-row: 1;width: 100%; margin-bottom: 0;">
  <h1><a href="https://james.walters.click">james.walters.click</a></h1>
  <h2>Thoughts and lessons learned along the path of software development.</h2>
  </hgroup>

  <div style="grid-row: 1; align-items: center; justify-content: end;">
    <img src="https://www.gravatar.com/avatar/04574f5e4a03ae08ef293b9adc5bc2e3?s=200&d=https%3A%2F%2Fraw.githubusercontent.com%2Fiamjameswalters%2Fpiccolo%2Fmain%2Fpiccolo.png" style="border-radius: 50%;">
  </div>
</section>
<article>
  <header>
    <hgroup>
    <h2>
      <a href="https://james.walters.click/insecurely-copying-text-in-javascript.html" rel="bookmark"
         title="Permalink to Insecurely Copying Text in Javascript">Insecurely Copying Text in Javascript</a></h2>
         <h3>By
          <a href="https://james.walters.click/author/james-walters.html">James Walters</a>           on <time class="published" datetime="2023-04-11T00:00:00-04:00">Tue 11 April 2023</time>.</h3>
    </hgroup>
          <aside style="grid-column: 2; display: flex; align-items: end; margin-bottom: 30px;">
           <div style="color: #73828c">Category: <a href="https://james.walters.click/category/web.html">Web</a>          <br />Tags: 
            <a href="https://james.walters.click/tag/javascript.html">JavaScript</a>        </div>
          </aside>
 
  </header>

  <p>I've been working on an internal web app at my job for our call and chat agents. There's some text provided there that agents commonly need to copy and paste. I thought it might be nice to write a bit of scripting to automatically copy these bits of text to the clipboard when the text is selected, without having to Ctrl-C.</p>
<p>After perusing the web, the obvious answer seemed to be to use JavaScript's <a href="https://devdocs.io/dom/clipboard">clipboard API</a>. In order to copy text, you would just write something like: </p>
<div class="highlight"><pre><span></span><code><span class="nx">navigator</span><span class="p">.</span><span class="nx">clipboard</span><span class="p">.</span><span class="nx">writeText</span><span class="p">(</span><span class="s2">&quot;text I want to copy&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<p>And indeed, this will work in something like 90% of your usecases. I ran into an edge case though.</p>
<h2>Let Me Stop You Right There üõëÔ∏è</h2>
<p>You see, the use of the clipboard API requires a <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts">secure context</a>. What exactly does that mean? It's probably a bit more nuanced than this, but <em>basically</em> it means you need to be connecting over HTTPS.</p>
<p>Remember how I mentioned this was an <strong>internal</strong> web app? We access it unencrypted. That means the clipboard API won't work. üò©Ô∏è</p>
<p>Is there any other way?</p>
<h2>I'll Copy Whatever I Darn Well Please</h2>
<p>It turns out there kind of is.</p>
<p>This <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Interact_with_the_clipboard#using_execcommand">MDN article</a> is a great resource on this topic. There's a deprecated API called <code>document.execCommand()</code> that allows you to do all kinds of things, one of which is <code>copy</code>. But if it's deprecated, how can we use it?</p>
<p>The key is in this condition (emphasis mine):</p>
<blockquote>
<p>These commands can be used without any special permission in <strong>short-lived event handlers</strong> for a user action (<strong>for example, a click handler</strong>).</p>
</blockquote>
<p>That's exactly our usecase. I'm assuming this API wouldn't work if you had it as part of a script. But as part of an <code>onclick</code> handler, the browser will execute it.</p>
<p>Running <code>document.execCommand('copy')</code> will copy whatever the currently selected text is to the clipboard, so you have to manually query for the element you need, call its <code>.select()</code> method to have the cursor select its text, and then call <code>document.execCommand('copy')</code>, which is a little cumbersome. In my case, I've got some CSS applied to a <code>&lt;span&gt;</code> such that whenever you click anywhere inside it, all of its text gets selected. That just leaves the copy logic. My code looks something like this:</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- span containing text to copy --&gt;</span>
<span class="p">&lt;</span><span class="nt">span</span> 
  <span class="na">style</span><span class="o">=</span><span class="s">&quot;user-select: all;&quot;</span>
  <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;document.execCommand(&#39;copy&#39;)&quot;</span><span class="p">&gt;</span>
  Copy this text
<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</code></pre></div>

<p>It's possible you could encounter a race condition where the command gets executed before the CSS, but that's never happened in any of my testing. Anyway, the solution would be to add a 50ms pause or something barely noticeable like that before running the command to give the CSS time to be processed.</p>
<p>Try it yourself! </p>
<div style="text-align: center;margin: 30px 0;">
<span style="user-select: all;" onclick="document.execCommand('copy')">
  Copy this text
</span>
</div>

<p>Did it work for you?</p>
<p>Anyway, that's how you can copy-and-paste something in JavaScript if you can't use <code>navigator.clipboard</code> for whatever reason, like serving from an "insecure context". I suspect serving web pages over unencrypted connections is still common enough for things like internal intranet sites that someone might need to know about this.</p>
<footer style="font-weight: bold; text-align: center;">
Found this helpful? <a href="https://ko-fi.com/iamjameswalters">Buy me a coffee!</a> ‚òïÔ∏è
</footer>

  </article>
  </main>
  <footer style="display: grid; grid-template-columns: repeat(auto-fit, [col-start] minmax(100px, 1fr) [col-end]); padding-top: 0;" class="container">
    <aside style="grid-row: 1;">
    <nav>
      <ul>
        <li><strong>Social:</strong></li>
      </ul>
      <ul>
      <li><a href="http://github.com/iamjameswalters" rel="me">Github</a></li>
      <li><a href="https://fosstodon.org/@jameswalters" rel="me">Mastodon</a></li>
      <li><a href="https://ko-fi.com/iamjameswalters" rel="me">By me a coffee (Ko-Fi)</a></li>
      <li><a href="mailto:iamjameswalters@gmail.com" rel="me">iamjameswalters@gmail.com</a></li>
      </ul>
    </nav>
    </aside>
    <aside style="grid-row: 1;">
    <nav>
      <ul>
        <li><strong>Links:</strong></li>
      </ul>
      <ul>
      <li><a href="https://hypermedia.systems/">Hypermedia Systems</a></li>
      <li><a href="https://grugbrain.dev/">The Grug Brained Developer</a></li>
      <li><a href="https://adamj.eu/tech">Adam Johnson's Blog</a></li>
      </ul>
    </nav>
    </aside>

    <aside style="grid-row: 1;">
    <nav>
      <ul>
        <li><strong>Feeds:</strong></li>
      </ul>
      <ul>
        <li><a href="https://james.walters.click/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom feed</a></li>
      </ul>
    </nav>
    </aside>

    <div style="grid-row: 2; grid-column: span 3;">
      <hr />
      <p style="padding-top: 0.5em;">
      Built using the <a href="https://github.com/iamjameswalters/piccolo">Piccolo</a> theme, based on <a href="https://picocss.com/">Pico.css</a>.</p>
    </div>
  </footer>
</body>

</html>